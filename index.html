<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Educadq - Gest√£o EAD Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #0f3460; --accent: #e94560; --success: #27ae60; --danger: #c0392b; --bg: #f4f7f6; --white: #fff; }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #333; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* Layout Responsivo Principal */
        .wrapper { display: flex; min-height: 100vh; flex-direction: row; }
        
        .sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; }
        .main { flex: 1; padding: 20px; max-width: 100%; box-sizing: border-box; }

        /* Ajustes para Celular (Telas menores que 768px) */
        @media (max-width: 768px) {
            .wrapper { flex-direction: column; }
            .sidebar { width: 100%; padding: 15px; box-sizing: border-box; text-align: center; }
            .main { padding: 15px; }
            iframe { height: 250px !important; } /* V√≠deo menor no celular */
        }

        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; transition: 0.3s; font-size: 15px; }
        .nav-item:hover, .active { background: var(--accent); }
        
        .card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Grid de Cursos Responsivo */
        #grid-cursos { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }

        @media (max-width: 480px) {
            #grid-cursos { grid-template-columns: 1fr; }
        }

        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin: 5px 0; width: 100%; display: block; text-align: center; box-sizing: border-box; }
        .btn-success { background: var(--success); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); font-size: 12px; padding: 8px; }
        .btn-disabled { background: #999; cursor: not-allowed; }
        
        .btn-download { background: #34495e; color: white; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 13px; display: inline-block; margin-top: 10px; font-weight: bold; }
        
        .progress-container { background: #eee; height: 12px; border-radius: 6px; margin-top: 10px; overflow: hidden; }
        .progress-bar { background: var(--success); height: 100%; transition: 0.8s; width: 0%; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        
        /* Tabela Responsiva */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }

        #video-frame { border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <section id="login-screen" style="display:flex; justify-content:center; align-items:center; min-height:100vh; background:var(--primary); padding: 20px;">
        <div class="card" style="width:100%; max-width:350px; text-align:center">
            <h2 style="color:var(--primary); margin-top:0;">EDUCADQ EAD</h2>
            <p>Acesso ao Aluno</p>
            <input type="email" id="email-login" placeholder="Seu E-mail">
            <input type="password" id="pass-login" placeholder="Sua Senha">
            <button class="btn btn-accent" onclick="login()">ENTRAR NO PORTAL</button>
        </div>
    </section>

    <section id="dash-screen" class="hidden">
        <div class="wrapper">
            <nav class="sidebar">
                <h3 id="user-display" style="margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Ol√°!</h3>
                <div class="nav-item active" onclick="showTab('tab-cursos')">üìö Meus Cursos</div>
                <div id="admin-tools" class="hidden">
                    <p style="font-size: 11px; text-transform: uppercase; opacity: 0.6; margin-top: 20px;">Painel de Gest√£o</p>
                    <div class="nav-item" onclick="showTab('tab-adm-cursos')">‚öôÔ∏è Cursos e Aulas</div>
                    <div class="nav-item" onclick="showTab('tab-adm-provas')">üìù Gerar Provas</div>
                    <div class="nav-item" onclick="abrirGerenciarAlunos()">üë• Gerenciar Alunos</div>
                </div>
                <div class="nav-item" style="margin-top:40px; color: #ffbcbc;" onclick="auth.signOut(); location.reload();">üö™ Sair do Sistema</div>
            </nav>

            <main class="main">
                <div id="tab-cursos" class="tab-content">
                    <h1>Meus Treinamentos</h1>
                    <div id="grid-cursos"></div>
                </div>

                <div id="tab-grade" class="tab-content hidden">
                    <button class="btn btn-accent" style="max-width: 150px;" onclick="showTab('tab-cursos')">‚¨Ö Voltar</button>
                    <h2 id="grade-titulo">Curso</h2>
                    <div id="lista-aulas"></div>
                    <div class="card" style="text-align:center">
                        <button id="btn-fazer-prova" class="btn btn-disabled" disabled>Fazer Prova Final</button>
                        <div id="btn-cert-area"></div>
                    </div>
                </div>

                <div id="tab-player" class="tab-content hidden">
                    <button class="btn btn-accent" style="max-width: 150px;" onclick="showTab('tab-grade')">‚¨Ö Voltar</button>
                    <h2 id="player-titulo">Aula</h2>
                    <div class="card" style="padding:0; overflow:hidden; background: #000;">
                        <iframe id="video-frame" width="100%" height="450" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <button id="btn-check-aula" class="btn btn-success">Marcar Aula como Conclu√≠da ‚úÖ</button>
                </div>

                <div id="tab-adm-alunos" class="tab-content hidden">
                    <h1>üë• Gerenciar Alunos</h1>
                    <div class="card">
                        <h3>Cadastrar Aluno</h3>
                        <input type="text" id="new-aluno-nome" placeholder="Nome Completo">
                        <input type="email" id="new-aluno-email" placeholder="E-mail de Acesso">
                        <input type="password" id="new-aluno-pass" placeholder="Senha Tempor√°ria">
                        <button class="btn btn-success" onclick="cadastrarAlunoFirebase()">CRIAR CONTA</button>
                    </div>
                    <div class="card">
                        <h3>Alunos Ativos</h3>
                        <div class="table-container">
                            <table id="tabela-alunos">
                                <thead><tr><th>Nome</th><th>E-mail</th><th>Fun√ß√£o</th></tr></thead>
                                <tbody id="lista-usuarios-corpo"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-adm-cursos" class="tab-content hidden">
                    <h1>‚öôÔ∏è Configurar Cursos</h1>
                    <div class="card">
                        <h3>1. Novo Curso</h3>
                        <input type="text" id="adm-c-nome" placeholder="Nome do Curso">
                        <input type="text" id="adm-c-capa" placeholder="URL da Foto de Capa">
                        <button class="btn btn-success" onclick="admCriarCurso()">SALVAR CURSO</button>
                    </div>
                    <div class="card">
                        <h3>2. Adicionar Aula e Material</h3>
                        <select id="select-cursos-aulas" onchange="listarAulasParaExcluir(this.value)">
                            <option value="">Selecione o Curso...</option>
                        </select>
                        <input type="text" id="adm-a-nome" placeholder="T√≠tulo da Aula">
                        <input type="text" id="adm-a-url" placeholder="Link YouTube (v=...)">
                        <input type="text" id="adm-a-material" placeholder="Link do PDF de Apoio (opcional)">
                        <button class="btn btn-success" onclick="admSalvarAula()">VINCULAR AULA</button>
                        <div id="lista-aulas-admin" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <div id="tab-adm-provas" class="tab-content hidden">
                    <h1>üìù Gerar Provas</h1>
                    <div class="card">
                        <select id="select-cursos-provas"></select>
                        <input type="text" id="adm-q" placeholder="Pergunta da Quest√£o">
                        <input type="text" id="opt0" placeholder="Op√ß√£o A">
                        <input type="text" id="opt1" placeholder="Op√ß√£o B">
                        <input type="text" id="opt2" placeholder="Op√ß√£o C">
                        <select id="adm-correta">
                            <option value="0">Correta: Op√ß√£o A</option>
                            <option value="1">Correta: Op√ß√£o B</option>
                            <option value="2">Correta: Op√ß√£o C</option>
                        </select>
                        <button class="btn btn-success" onclick="admSalvarQuestao()">SALVAR NA PROVA</button>
                    </div>
                </div>
                
                <div id="tab-prova" class="tab-content hidden">
                    <h1>Avalia√ß√£o de Conhecimento</h1>
                    <div id="questoes-container"></div>
                    <button class="btn btn-success" onclick="corrigirProva()">ENVIAR RESPOSTAS</button>
                </div>

                <div id="tab-cert" class="tab-content hidden">
                    <button class="btn btn-accent" style="max-width: 150px;" onclick="showTab('tab-grade')">‚¨Ö Voltar</button>
                    <button class="btn btn-success" style="max-width: 200px;" onclick="window.print()">üñ®Ô∏è BAIXAR / IMPRIMIR</button>
                    <div id="printable-certificate">
                        <div style="border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px;">
                            <h2>Educadq - Centro de Forma√ß√£o</h2>
                            <p>CNPJ: 50.062.731/0001-30</p>
                        </div>
                        <p>Certificamos para os devidos fins que</p>
                        <h1 id="cert-nome-aluno" style="color:var(--accent); font-size: 30px;">NOME</h1>
                        <p>concluiu com √™xito o treinamento de</p>
                        <h2 id="cert-curso-nome" style="color:var(--primary)">NOME DO CURSO</h2>
                        <div style="margin-top:50px; border-top:1px solid #333; display:inline-block; width:250px">Dire√ß√£o Educadq</div>
                    </div>
                </div>

            </main>
        </div>
    </section>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBtshykteNPifgHzy8iBSYPEmNfERZqZ8A",
            authDomain: "educadq-ead.firebaseapp.com",
            databaseURL: "https://educadq-ead-default-rtdb.firebaseio.com",
            projectId: "educadq-ead",
            storageBucket: "educadq-ead.firebasestorage.app",
            messagingSenderId: "271063448895",
            appId: "1:271063448895:web:7ad4473d1eac8c4a47278a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let userData = null; let cursosData = {}; let cursoAtualId = null;

        function login() {
            const email = document.getElementById('email-login').value;
            const pass = document.getElementById('pass-login').value;
            if(!email || !pass) return alert("Preencha os campos!");
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert("Erro: Senha ou E-mail incorretos."));
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dash-screen').classList.remove('hidden');
                carregarBase(user.uid);
            }
        });

        function carregarBase(uid) {
            db.ref('cursos').on('value', snap => { cursosData = snap.val() || {}; renderHome(); renderSelects(); });
            db.ref('usuarios/' + uid).on('value', snap => {
                userData = snap.val();
                if(!userData) {
                    userData = { nome: auth.currentUser.email.split('@')[0], email: auth.currentUser.email, role: 'aluno', progresso: {}, notas: {} };
                    db.ref('usuarios/' + uid).set(userData);
                }
                document.getElementById('user-display').innerText = "Ol√°, " + (userData.nome.split(' ')[0]);
                if(userData.role === 'admin') document.getElementById('admin-tools').classList.remove('hidden');
                renderHome();
            });
        }

        function renderHome() {
            const grid = document.getElementById('grid-cursos'); grid.innerHTML = "";
            if(!userData) return;
            Object.keys(cursosData).forEach(id => {
                const c = cursosData[id];
                const total = c.aulas ? Object.keys(c.aulas).length : 0;
                const done = (userData.progresso && userData.progresso[id]) ? Object.values(userData.progresso[id]).length : 0;
                const perc = total > 0 ? Math.round((done / total) * 100) : 0;

                grid.innerHTML += `
                    <div class="card" onclick="abrirGrade('${id}')" style="cursor:pointer">
                        <img src="${c.capa}" width="100%" height="150" style="object-fit:cover; border-radius:8px">
                        <h3 style="margin:12px 0 5px 0">${c.nome}</h3>
                        <div class="progress-container"><div class="progress-bar" style="width:${perc}%"></div></div>
                        <small>${perc}% conclu√≠do</small>
                    </div>`;
            });
        }

        function abrirGrade(id) {
            cursoAtualId = id; const c = cursosData[id];
            document.getElementById('grade-titulo').innerText = c.nome;
            const lista = document.getElementById('lista-aulas'); lista.innerHTML = "";
            const aulas = c.aulas || {}; const keys = Object.keys(aulas);
            const done = (userData.progresso && userData.progresso[id]) ? Object.values(userData.progresso[id]) : [];

            keys.forEach((aId, idx) => {
                const icon = done.includes(aId) ? "‚úÖ" : "‚≠ï";
                const mat = aulas[aId].material ? `<a href="${aulas[aId].material}" target="_blank" class="btn-download" onclick="event.stopPropagation()">üìÇ Material Extra</a>` : "";
                lista.innerHTML += `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap;">
                        <div style="flex:1; min-width: 200px;">
                            <strong>${icon} Aula ${idx+1}: ${aulas[aId].nome}</strong><br>${mat}
                        </div>
                        <button class="btn btn-success" style="width: auto; margin-top:10px;" onclick="assistir('${aId}')">ASSISTIR</button>
                    </div>`;
            });

            const btnP = document.getElementById('btn-fazer-prova');
            if(keys.length > 0 && done.length >= keys.length) {
                btnP.disabled = false; btnP.className = "btn btn-accent";
                btnP.onclick = () => mostrarProva(id);
            } else { btnP.disabled = true; btnP.className = "btn btn-disabled"; }

            if(userData.notas && userData.notas[id] >= 70) {
                document.getElementById('btn-cert-area').innerHTML = `<button class="btn btn-success" onclick="verCertificado('${id}')">VER MEU CERTIFICADO</button>`;
            } else { document.getElementById('btn-cert-area').innerHTML = ""; }
            showTab('tab-grade');
        }

        function assistir(aId) {
            const aula = cursosData[cursoAtualId].aulas[aId];
            document.getElementById('player-titulo').innerText = aula.nome;
            document.getElementById('video-frame').src = aula.url;
            document.getElementById('btn-check-aula').onclick = () => {
                let pRef = db.ref('usuarios/' + auth.currentUser.uid + '/progresso/' + cursoAtualId);
                pRef.get().then(snap => {
                    let p = snap.val() || []; if(!p.includes(aId)) p.push(aId);
                    pRef.set(p).then(() => { alert("Aula conclu√≠da!"); abrirGrade(cursoAtualId); });
                });
            };
            showTab('tab-player');
        }

        // ADMIN FUNCTIONS
        function admCriarCurso() {
            const n = document.getElementById('adm-c-nome').value; 
            const c = document.getElementById('adm-c-capa').value;
            if(n && c) db.ref('cursos').push({nome: n, capa: c}).then(()=>alert("Criado!"));
        }

        function admSalvarAula() {
            const cId = document.getElementById('select-cursos-aulas').value;
            const n = document.getElementById('adm-a-nome').value;
            let u = document.getElementById('adm-a-url').value;
            const mat = document.getElementById('adm-a-material').value;
            if(!cId || !n || !u) return alert("Preencha os campos obrigat√≥rios.");
            let idV = u.includes("v=") ? u.split("v=")[1].split("&")[0] : u.split("/").pop();
            db.ref('cursos/'+cId+'/aulas').push({nome:n, url:`https://www.youtube.com/embed/${idV}`, material: mat || ""}).then(()=>{
                alert("Aula Vinculada!"); listarAulasParaExcluir(cId);
            });
        }

        function listarAulasParaExcluir(cId) {
            const cont = document.getElementById('lista-aulas-admin'); cont.innerHTML = "";
            const aulas = (cursosData[cId] && cursosData[cId].aulas) ? cursosData[cId].aulas : {};
            Object.keys(aulas).forEach(aId => {
                cont.innerHTML += `<div style="background:#eee; padding:10px; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span>${aulas[aId].nome}</span><button class="btn-danger" onclick="excluirAula('${cId}','${aId}')">X</button></div>`;
            });
        }

        function excluirAula(cId, aId) { if(confirm("Excluir?")) db.ref(`cursos/${cId}/aulas/${aId}`).remove().then(()=>listarAulasParaExcluir(cId)); }

        function admSalvarQuestao() {
            const cId = document.getElementById('select-cursos-provas').value;
            const q = { pergunta: document.getElementById('adm-q').value, opts: [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value], correta: document.getElementById('adm-correta').value };
            db.ref('cursos/' + cId + '/questoes').push(q).then(()=>alert("Salvo!"));
        }

        function mostrarProva(id) {
            const qs = cursosData[id].questoes; if(!qs) return alert("Sem prova.");
            const cont = document.getElementById('questoes-container'); cont.innerHTML = "";
            Object.keys(qs).forEach((qId, idx) => {
                cont.innerHTML += `<div class="card"><p><strong>${idx+1}. ${qs[qId].pergunta}</strong></p>
                ${qs[qId].opts.map((o, i) => `<label style="display:block; margin:10px 0;"><input type="radio" name="q${qId}" value="${i}"> ${o}</label>`).join('')}</div>`;
            });
            showTab('tab-prova');
        }

        function corrigirProva() {
            const qs = cursosData[cursoAtualId].questoes; let ok = 0; const ids = Object.keys(qs);
            ids.forEach(id => {
                const s = document.querySelector(`input[name="q${id}"]:checked`);
                if(s && s.value == qs[id].correta) ok++;
            });
            const nota = (ok / ids.length) * 100;
            db.ref('usuarios/' + auth.currentUser.uid + '/notas/' + cursoAtualId).set(nota).then(() => {
                alert("Sua Nota: " + nota.toFixed(0) + "%"); abrirGrade(cursoAtualId);
            });
        }

        async function cadastrarAlunoFirebase() {
            const n = document.getElementById('new-aluno-nome').value;
            const e = document.getElementById('new-aluno-email').value;
            const p = document.getElementById('new-aluno-pass').value;
            const secApp = firebase.initializeApp(firebaseConfig, "Secondary");
            try {
                const res = await secApp.auth().createUserWithEmailAndPassword(e, p);
                await db.ref('usuarios/' + res.user.uid).set({ nome: n, email: e, role: 'aluno', progresso: {}, notas: {} });
                alert("Aluno cadastrado com sucesso!"); await secApp.delete(); abrirGerenciarAlunos();
            } catch (err) { alert(err.message); }
        }

        function abrirGerenciarAlunos() {
            db.ref('usuarios').once('value', snap => {
                const corpo = document.getElementById('lista-usuarios-corpo'); corpo.innerHTML = "";
                const us = snap.val();
                if(us) Object.keys(us).forEach(id => {
                    corpo.innerHTML += `<tr><td>${us[id].nome}</td><td>${us[id].email}</td><td>${us[id].role}</td></tr>`;
                });
                showTab('tab-adm-alunos');
            });
        }

        function verCertificado(id) {
            document.getElementById('cert-nome-aluno').innerText = userData.nome.toUpperCase();
            document.getElementById('cert-curso-nome').innerText = cursosData[id].nome.toUpperCase();
            showTab('tab-cert');
        }

        function renderSelects() {
            const s1 = document.getElementById('select-cursos-aulas'); const s2 = document.getElementById('select-cursos-provas');
            s1.innerHTML = "<option value=''>Selecionar...</option>"; s2.innerHTML = "";
            Object.keys(cursosData).forEach(id => { const o = `<option value="${id}">${cursosData[id].nome}</option>`; s1.innerHTML += o; s2.innerHTML += o; });
        }

        function showTab(id) { 
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden'); 
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
