<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educadq - Gest√£o EAD</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #0f3460; --accent: #e94560; --success: #27ae60; --bg: #f4f7f6; --white: #fff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #333; }
        .hidden { display: none !important; }
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; }
        .main { flex: 1; padding: 30px; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; transition: 0.3s; }
        .nav-item:hover, .active { background: var(--accent); }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin: 5px 0; }
        .btn-success { background: var(--success); }
        .btn-accent { background: var(--accent); }
        .btn-disabled { background: #999; cursor: not-allowed; }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        
        #printable-certificate { width: 750px; padding: 50px; border: 15px double var(--primary); background: white; text-align: center; margin: 20px auto; }
        @media print { body * { visibility: hidden; } #printable-certificate, #printable-certificate * { visibility: visible; } #printable-certificate { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>

    <section id="login-screen" style="display:flex; justify-content:center; align-items:center; height:100vh; background:var(--primary)">
        <div class="card" style="width:350px; text-align:center">
            <h2 style="color:var(--primary)">EDUCADQ EAD</h2>
            <input type="email" id="email-login" placeholder="E-mail">
            <input type="password" id="pass-login" placeholder="Senha">
            <button class="btn btn-accent" style="width:100%" onclick="login()">ENTRAR</button>
        </div>
    </section>

    <section id="dash-screen" class="hidden">
        <div class="wrapper">
            <nav class="sidebar">
                <h3 id="user-display">Carregando...</h3>
                <div class="nav-item active" onclick="showTab('tab-cursos')">üìö Meus Cursos</div>
                <div id="admin-tools" class="hidden">
                    <hr>
                    <div class="nav-item" onclick="showTab('tab-adm-cursos')">‚öôÔ∏è Cursos e Aulas</div>
                    <div class="nav-item" onclick="showTab('tab-adm-provas')">üìù Gerar Provas</div>
                    <div class="nav-item" onclick="abrirGerenciarAlunos()">üë• Cadastrar/Gerenciar Alunos</div>
                </div>
                <div class="nav-item" style="margin-top:20px; opacity: 0.8" onclick="auth.signOut(); location.reload();">üö™ Sair</div>
            </nav>

            <main class="main">
                <div id="tab-cursos" class="tab-content">
                    <h1>Meus Treinamentos</h1>
                    <div id="grid-cursos" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
                </div>

                <div id="tab-grade" class="tab-content hidden">
                    <button class="btn btn-accent" onclick="showTab('tab-cursos')">‚¨Ö Voltar</button>
                    <h1 id="grade-titulo">Curso</h1>
                    <div id="lista-aulas"></div>
                    <div class="card" style="text-align:center">
                        <button id="btn-fazer-prova" class="btn btn-disabled" disabled>Fazer Prova Final</button>
                        <div id="btn-cert-area"></div>
                    </div>
                </div>

                <div id="tab-player" class="tab-content hidden">
                    <button class="btn btn-accent" onclick="showTab('tab-grade')">‚¨Ö Voltar</button>
                    <h2 id="player-titulo">Aula</h2>
                    <div class="card" style="padding:0; overflow:hidden">
                        <iframe id="video-frame" width="100%" height="450" frameborder="0" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
                    </div>
                    <button id="btn-check-aula" class="btn btn-success" style="width:100%">Concluir esta Aula ‚úÖ</button>
                </div>

                <div id="tab-prova" class="tab-content hidden">
                    <h1 id="prova-titulo">Avalia√ß√£o</h1>
                    <div id="questoes-container"></div>
                    <button class="btn btn-success" style="width:100%" onclick="corrigirProva()">Finalizar e Enviar</button>
                </div>

                <div id="tab-cert" class="tab-content hidden">
                    <button class="btn btn-accent" onclick="showTab('tab-grade')">‚¨Ö Voltar</button>
                    <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                    <div id="printable-certificate">
                        <div style="border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px;">
                            <h2>Centro de Forma√ß√£o Educadq</h2>
                            <p>CNPJ: 50.062.731/0001-30 | Pontal do Paran√°, PR</p>
                        </div>
                        <p>Certificamos que</p>
                        <h1 id="cert-nome-aluno" style="color:var(--accent); font-size: 35px;">NOME</h1>
                        <p>concluiu o treinamento de</p>
                        <h2 id="cert-curso-nome" style="color:var(--primary)">NOME DO CURSO</h2>
                        <div style="margin-top:60px; border-top:1px solid #333; display:inline-block; width:280px">Dire√ß√£o Educadq</div>
                    </div>
                </div>

                <div id="tab-adm-alunos" class="tab-content hidden">
                    <h1>Gerenciar Alunos</h1>
                    <div class="card" style="max-width: 500px;">
                        <h3>‚ûï Cadastrar Novo Aluno</h3>
                        <input type="text" id="new-aluno-nome" placeholder="Nome Completo do Aluno">
                        <input type="email" id="new-aluno-email" placeholder="E-mail">
                        <input type="password" id="new-aluno-pass" placeholder="Defina uma Senha">
                        <button class="btn btn-success" onclick="cadastrarAlunoFirebase()">CADASTRAR ALUNO</button>
                    </div>
                    
                    <div class="card">
                        <h3>Alunos Cadastrados</h3>
                        <table id="tabela-alunos">
                            <thead><tr><th>Nome</th><th>E-mail</th><th>Status</th></tr></thead>
                            <tbody id="lista-usuarios-corpo"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-adm-cursos" class="tab-content hidden">
                    <h1>Configurar Cursos</h1>
                    <div class="card">
                        <h3>1. Novo Curso</h3>
                        <input type="text" id="adm-c-nome" placeholder="Nome do Curso">
                        <input type="text" id="adm-c-capa" placeholder="URL da Foto de Capa">
                        <button class="btn btn-success" onclick="admCriarCurso()">Salvar Curso</button>
                    </div>
                    <div class="card">
                        <h3>2. Adicionar Aula</h3>
                        <select id="select-cursos-aulas"></select>
                        <input type="text" id="adm-a-nome" placeholder="T√≠tulo da Aula">
                        <input type="text" id="adm-a-url" placeholder="Link do YouTube">
                        <button class="btn btn-success" onclick="admSalvarAula()">Vincular Aula</button>
                    </div>
                </div>

                <div id="tab-adm-provas" class="tab-content hidden">
                    <h1>Gerar Provas</h1>
                    <div class="card">
                        <select id="select-cursos-provas"></select>
                        <input type="text" id="adm-q" placeholder="Pergunta">
                        <input type="text" id="opt0" placeholder="A"> <input type="text" id="opt1" placeholder="B"> <input type="text" id="opt2" placeholder="C">
                        <select id="adm-correta"><option value="0">Correta: A</option><option value="1">Correta: B</option><option value="2">Correta: C</option></select>
                        <button class="btn btn-success" onclick="admSalvarQuestao()">Salvar Quest√£o</button>
                    </div>
                </div>
            </main>
        </div>
    </section>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBtshykteNPifgHzy8iBSYPEmNfERZqZ8A",
            authDomain: "educadq-ead.firebaseapp.com",
            databaseURL: "https://educadq-ead-default-rtdb.firebaseio.com",
            projectId: "educadq-ead",
            storageBucket: "educadq-ead.firebasestorage.app",
            messagingSenderId: "271063448895",
            appId: "1:271063448895:web:7ad4473d1eac8c4a47278a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let userData = null; let cursosData = {}; let cursoAtualId = null;

        function login() {
            const email = document.getElementById('email-login').value;
            const pass = document.getElementById('pass-login').value;
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert("Erro: " + e.message));
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dash-screen').classList.remove('hidden');
                carregarBase(user.uid);
            }
        });

        function carregarBase(uid) {
            db.ref('cursos').on('value', snap => { cursosData = snap.val() || {}; renderHome(); renderSelects(); });
            db.ref('usuarios/' + uid).on('value', snap => {
                userData = snap.val();
                if(!userData) {
                    userData = { nome: auth.currentUser.email.split('@')[0], email: auth.currentUser.email, role: 'aluno', progresso: {}, notas: {} };
                    db.ref('usuarios/' + uid).set(userData);
                }
                document.getElementById('user-display').innerText = "Ol√°, " + userData.nome;
                if(userData.role === 'admin') document.getElementById('admin-tools').classList.remove('hidden');
            });
        }

        // --- FUN√á√ÉO PARA CADASTRAR ALUNO PELO DASHBOARD ---
        async function cadastrarAlunoFirebase() {
            const nome = document.getElementById('new-aluno-nome').value;
            const email = document.getElementById('new-aluno-email').value;
            const pass = document.getElementById('new-aluno-pass').value;

            if(!nome || !email || !pass) return alert("Preencha todos os campos do aluno!");

            // Criamos uma segunda inst√¢ncia do Firebase Auth tempor√°ria para n√£o deslogar o admin
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            
            try {
                const userCredential = await secondaryApp.auth().createUserWithEmailAndPassword(email, pass);
                const uid = userCredential.user.uid;

                // Salva no banco de dados
                await db.ref('usuarios/' + uid).set({
                    nome: nome,
                    email: email,
                    role: 'aluno',
                    progresso: {},
                    notas: {}
                });

                alert("Aluno cadastrado com sucesso!");
                document.getElementById('new-aluno-nome').value = "";
                document.getElementById('new-aluno-email').value = "";
                document.getElementById('new-aluno-pass').value = "";
                abrirGerenciarAlunos();
                
                await secondaryApp.delete();
            } catch (error) {
                alert("Erro ao cadastrar: " + error.message);
            }
        }

        function abrirGerenciarAlunos() {
            db.ref('usuarios').once('value', snap => {
                const corpo = document.getElementById('lista-usuarios-corpo'); corpo.innerHTML = "";
                const us = snap.val();
                if(us) {
                    Object.keys(us).forEach(id => {
                        corpo.innerHTML += `<tr><td>${us[id].nome}</td><td>${us[id].email}</td><td>${us[id].role}</td></tr>`;
                    });
                }
                showTab('tab-adm-alunos');
            });
        }

        // --- RESTANTE DAS FUN√á√ïES ---
        function renderHome() {
            const grid = document.getElementById('grid-cursos'); grid.innerHTML = "";
            Object.keys(cursosData).forEach(id => {
                grid.innerHTML += `<div class="card" onclick="abrirGrade('${id}')" style="cursor:pointer">
                    <img src="${cursosData[id].capa}" width="100%" height="150" style="object-fit:cover; border-radius:10px">
                    <h3>${cursosData[id].nome}</h3></div>`;
            });
        }

        function abrirGrade(id) {
            cursoAtualId = id; const curso = cursosData[id];
            document.getElementById('grade-titulo').innerText = curso.nome;
            const lista = document.getElementById('lista-aulas'); lista.innerHTML = "";
            const aulas = curso.aulas || {}; const keys = Object.keys(aulas);
            const concluidas = (userData.progresso && userData.progresso[id]) ? Object.values(userData.progresso[id]) : [];

            keys.forEach((aId, idx) => {
                const icon = concluidas.includes(aId) ? "‚úÖ" : "‚≠ï";
                lista.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center">
                    <span>${icon} Aula ${idx+1}: ${aulas[aId].nome}</span>
                    <button class="btn btn-success" onclick="assistir('${aId}')">Assistir</button></div>`;
            });

            const btnP = document.getElementById('btn-fazer-prova');
            if(keys.length > 0 && concluidas.length >= keys.length) {
                btnP.disabled = false; btnP.className = "btn btn-accent";
                btnP.onclick = () => mostrarProva(id);
            }
            if(userData.notas && userData.notas[id] >= 70) {
                document.getElementById('btn-cert-area').innerHTML = `<button class="btn btn-success" onclick="verCertificado('${id}')">MEU CERTIFICADO</button>`;
            } else { document.getElementById('btn-cert-area').innerHTML = ""; }
            showTab('tab-grade');
        }

        function assistir(aId) {
            const aula = cursosData[cursoAtualId].aulas[aId];
            document.getElementById('player-titulo').innerText = aula.nome;
            document.getElementById('video-frame').src = aula.url;
            document.getElementById('btn-check-aula').onclick = () => {
                let progRef = db.ref('usuarios/' + auth.currentUser.uid + '/progresso/' + cursoAtualId);
                progRef.get().then(snap => {
                    let p = snap.val() || []; if(!p.includes(aId)) p.push(aId);
                    progRef.set(p).then(() => { alert("Aula conclu√≠da!"); abrirGrade(cursoAtualId); });
                });
            };
            showTab('tab-player');
        }

        function mostrarProva(id) {
            const qs = cursosData[id].questoes; if(!qs) return alert("Prova n√£o cadastrada.");
            const cont = document.getElementById('questoes-container'); cont.innerHTML = "";
            Object.keys(qs).forEach((qId, idx) => {
                cont.innerHTML += `<div class="card"><p><strong>${idx+1}. ${qs[qId].pergunta}</strong></p>
                ${qs[qId].opts.map((o, i) => `<label style="display:block"><input type="radio" name="q${qId}" value="${i}"> ${o}</label>`).join('')}</div>`;
            });
            showTab('tab-prova');
        }

        function corrigirProva() {
            const qs = cursosData[cursoAtualId].questoes; let acertos = 0; const ids = Object.keys(qs);
            ids.forEach(id => {
                const sel = document.querySelector(`input[name="q${id}"]:checked`);
                if(sel && sel.value == qs[id].correta) acertos++;
            });
            const nota = (acertos / ids.length) * 100;
            db.ref('usuarios/' + auth.currentUser.uid + '/notas/' + cursoAtualId).set(nota).then(() => {
                alert("Nota: " + nota.toFixed(0) + "%"); abrirGrade(cursoAtualId);
            });
        }

        function verCertificado(id) {
            document.getElementById('cert-nome-aluno').innerText = userData.nome.toUpperCase();
            document.getElementById('cert-curso-nome').innerText = cursosData[id].nome.toUpperCase();
            showTab('tab-cert');
        }

        function admCriarCurso() {
            const n = document.getElementById('adm-c-nome').value; const c = document.getElementById('adm-c-capa').value;
            if(n && c) db.ref('cursos').push({nome: n, capa: c});
        }

        function admSalvarAula() {
            const cId = document.getElementById('select-cursos-aulas').value; const n = document.getElementById('adm-a-nome').value;
            let u = document.getElementById('adm-a-url').value;
            let idV = u.includes("v=") ? u.split("v=")[1].split("&")[0] : u.split("/").pop();
            db.ref('cursos/' + cId + '/aulas').push({nome: n, url: `https://www.youtube.com/embed/${idV}`});
        }

        function admSalvarQuestao() {
            const cId = document.getElementById('select-cursos-provas').value;
            const q = { pergunta: document.getElementById('adm-q').value, opts: [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value], correta: document.getElementById('adm-correta').value };
            db.ref('cursos/' + cId + '/questoes').push(q); alert("Salvo!");
        }

        function renderSelects() {
            const s1 = document.getElementById('select-cursos-aulas'); const s2 = document.getElementById('select-cursos-provas');
            s1.innerHTML = s2.innerHTML = ""; Object.keys(cursosData).forEach(id => { const o = `<option value="${id}">${cursosData[id].nome}</option>`; s1.innerHTML += o; s2.innerHTML += o; });
        }

        function showTab(id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    </script>
</body>
</html>
